<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengaduan Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F0F4F8; /* Light blue-gray background */
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #001F3F; /* Navy */
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .hidden {
            display: none;
        }
        .login-bg {
            background-color: #001F3F; /* Basis Navy */
            background-image: radial-gradient(circle at 15% 15%, hsla(46, 65%, 52%, 0.25) 0%, transparent 40%),
                              radial-gradient(circle at 85% 75%, hsla(349, 45%, 65%, 0.2) 0%, transparent 40%);
            background-size: cover;
            background-position: center;
        }
        .btn-primary {
            background-color: #001F3F; /* Navy */
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #003366; /* Darker Navy */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 31, 63, 0.3);
        }
        .btn-secondary {
            background-color: #ffffff;
            color: #001F3F; /* Navy */
            border: 1px solid #e0e0e0;
             transition: all 0.3s ease;
        }
        .btn-secondary:hover {
             background-color: #f1f1f1;
        }
        .btn-yellow {
             background-color: #FBBF24; /* Yellow Accent - amber-400 */
             color: #001F3F;
             font-weight: 600;
             transition: all 0.3s ease;
        }
        .btn-yellow:hover {
            background-color: #F59E0B; /* amber-500 */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
        }
        .btn-yellow:disabled {
            background-color: #FCD34D;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .form-input {
            border: 1px solid #D1D5DB;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #FBBF24; /* Yellow Accent */
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left-width: 5px;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        /* Status Border Colors */
        .card-status-Terkirim { border-left-color: #3B82F6; }
        .card-status-Diproses { border-left-color: #F59E0B; }
        .card-status-Selesai { border-left-color: #10B981; }
        .card-status-Ditolak { border-left-color: #EF4444; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Halaman Login / Homepage Banner -->
    <div id="login-container" class="min-h-screen flex flex-col items-center justify-center login-bg p-4">
        <div class="max-w-md w-full text-center text-white p-8">
            <h1 class="text-5xl md:text-6xl font-bold mb-4" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3)">Portal Pengaduan Siswa</h1>
            <p class="text-lg text-gray-200 mb-10">Salurkan aspirasimu tanpa batasan</p>
            
            <!-- Tombol Login Utama -->
            <div id="main-login-buttons" class="space-y-4">
                <button id="login-siswa" class="w-full text-lg bg-white text-[#001F3F] font-semibold py-3 px-4 rounded-lg hover:bg-gray-200 transition duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>Masuk sebagai Siswa</span>
                </button>
                <button id="show-admin-login" class="w-full text-lg bg-black bg-opacity-50 text-white font-semibold py-3 px-4 rounded-lg hover:bg-opacity-70 border border-gray-300 transition duration-300 hover:scale-105 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Masuk sebagai Admin</span>
                </button>
            </div>

            <!-- Form Password Admin (Disembunyikan) -->
            <div id="admin-login-form" class="hidden mt-4 bg-black bg-opacity-30 p-6 rounded-lg backdrop-blur-sm">
                <h3 class="text-xl font-semibold mb-4">Login Admin</h3>
                <form id="admin-password-form">
                    <input type="password" id="admin-password" placeholder="Masukkan Password" class="w-full px-4 py-2 rounded-lg text-gray-800 form-input mb-4" required>
                    <div class="flex gap-4">
                        <button type="submit" class="w-full text-lg btn-primary py-2 px-4 rounded-lg">Login</button>
                        <button type="button" id="cancel-admin-login" class="w-full text-lg bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition">Batal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Konten Aplikasi Utama -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <header class="bg-[#001F3F] rounded-xl shadow-lg p-4 flex justify-between items-center mb-8">
              <div>
                  <h1 class="text-2xl md:text-3xl font-bold text-white">Beranda Aspirasi</h1>
              </div>
              <div class="flex items-center gap-4">
                  <button id="show-form-button" class="py-2 px-4 rounded-lg btn-yellow flex items-center gap-2 hidden">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                      </svg>
                      <span>Buat Laporan</span>
                  </button>
                  <button id="logout-button" class="font-semibold py-2 px-4 rounded-lg btn-secondary transition duration-300">
                      Keluar
                  </button>
              </div>
        </header>

        <main>
            <!-- Form untuk Laporan Baru (Hanya untuk Siswa, disembunyikan secara default) -->
            <section id="form-laporan" class="bg-white rounded-xl shadow-lg overflow-hidden mb-8 hidden">
                <div class="bg-gradient-to-r from-[#001F3F] to-[#003366] p-5">
                    <h2 class="text-2xl font-semibold text-white">Buat Laporan Baru</h2>
                    <p class="text-sm text-gray-300 mt-1">Isi formulir di bawah ini untuk mengirimkan aspirasimu.</p>
                </div>
                <form id="complaintForm" class="p-6">
                    <div class="mb-4">
                        <label for="judul" class="block text-gray-700 font-medium mb-2">Judul Laporan</label>
                        <input type="text" id="judul" name="judul" placeholder="Contoh: Fasilitas Toilet Rusak" class="w-full px-4 py-2 rounded-lg form-input" required>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="nama" class="block text-gray-700 font-medium mb-2">Nama Anda (Opsional)</label>
                            <input type="text" id="nama" name="nama" placeholder="Masukkan nama Anda" class="w-full px-4 py-2 rounded-lg form-input">
                        </div>
                        <div class="md:mt-9">
                            <label class="flex items-center text-gray-700 cursor-pointer">
                                <input type="checkbox" id="anonim" class="h-5 w-5 text-[#001F3F] border-gray-300 rounded focus:ring-[#001F3F]">
                                <span class="ml-2">Kirim sebagai anonim</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="laporan" class="block text-gray-700 font-medium mb-2">Isi Laporan Anda</label>
                        <textarea id="laporan" name="laporan" rows="5" placeholder="Tuliskan keluhan atau aspirasi Anda di sini..." class="w-full px-4 py-2 rounded-lg form-input" required></textarea>
                    </div>
                    <div class="flex gap-4 mt-6">
                         <button type="submit" class="w-full py-3 px-4 rounded-lg btn-yellow">
                             Kirim Laporan
                         </button>
                        <button type="button" id="cancel-form-button" class="w-full font-semibold py-3 px-4 rounded-lg btn-secondary">
                            Batal
                        </button>
                    </div>
                </form>
            </section>

            <!-- Daftar Laporan -->
            <section id="daftar-laporan">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                    <h2 class="text-2xl font-semibold text-[#001F3F] border-b-2 border-[#FBBF24] pb-2 mb-4 sm:mb-0">Daftar Laporan</h2>
                    <div id="filter-container" class="flex flex-wrap gap-2 hidden"></div>
                </div>

                <div id="laporan-container" class="space-y-6">
                    <!-- Template Loading -->
                     <div class="card p-4 animate-pulse card-status-Terkirim">
                         <div class="h-6 bg-gray-200 rounded w-3/4 mb-3"></div>
                         <div class="h-4 bg-gray-200 rounded w-1/4 mb-5"></div>
                         <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                         <div class="h-4 bg-gray-200 rounded w-full mb-4"></div>
                         <div class="h-16 bg-gray-200 rounded w-full mt-4"></div>
                     </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>&copy; 2025 Divisi Kesiswaan. Hak Cipta Dilindungi.</p>
        </footer>
    </div>
    
    <div id="toast" class="toast">Pesan notifikasi</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO_PROJECT" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- State Aplikasi ---
        let currentUserRole = null; // 'siswa' atau 'admin'
        let currentFilter = 'Semua'; // 'Semua', 'Terkirim', 'Diproses', 'Selesai', 'Ditolak'

        // --- Elemen DOM ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginSiswaBtn = document.getElementById('login-siswa');
        const mainLoginButtons = document.getElementById('main-login-buttons');
        const showAdminLoginBtn = document.getElementById('show-admin-login');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminPasswordForm = document.getElementById('admin-password-form');
        const adminPasswordInput = document.getElementById('admin-password');
        const cancelAdminLoginBtn = document.getElementById('cancel-admin-login');
        const logoutBtn = document.getElementById('logout-button');
        const showFormButton = document.getElementById('show-form-button');
        const cancelFormButton = document.getElementById('cancel-form-button');
        const formLaporan = document.getElementById('form-laporan');
        const complaintForm = document.getElementById('complaintForm');
        const judulInput = document.getElementById('judul');
        const namaInput = document.getElementById('nama');
        const anonimCheckbox = document.getElementById('anonim');
        const laporanInput = document.getElementById('laporan');
        const laporanContainer = document.getElementById('laporan-container');
        const filterContainer = document.getElementById('filter-container');
        
        const laporanCollection = collection(db, `artifacts/${appId}/public/data/pengaduan`);

        // --- Fungsi ---
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
        
        function updateView() {
            if (currentUserRole) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                if (currentUserRole === 'siswa') {
                    showFormButton.classList.remove('hidden');
                    formLaporan.classList.add('hidden');
                    filterContainer.classList.add('hidden');
                } else { // admin
                    showFormButton.classList.add('hidden');
                    formLaporan.classList.add('hidden');
                    filterContainer.classList.remove('hidden');
                    renderFilterButtons();
                }
                
                renderAllLaporan();
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }

        async function authenticateAndInit() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                listenToLaporan();
            } catch (error) {
                console.error("Error saat autentikasi:", error);
            }
        }
        
        anonimCheckbox.addEventListener('change', () => {
            namaInput.disabled = anonimCheckbox.checked;
            if (anonimCheckbox.checked) {
                namaInput.value = '';
                namaInput.classList.add('bg-gray-200');
            } else {
                namaInput.classList.remove('bg-gray-200');
            }
        });

        complaintForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = complaintForm.querySelector('button[type="submit"]');

            if (!laporanInput.value.trim() || !judulInput.value.trim()) {
                showToast("Judul dan isi laporan tidak boleh kosong.");
                return;
            }

            // Disable button to prevent multiple submissions
            submitButton.disabled = true;
            submitButton.textContent = 'Mengirim...';

            const isAnonim = anonimCheckbox.checked;
            const namaPelapor = isAnonim ? 'Anonim' : (namaInput.value.trim() || 'Anonim');
            
            try {
                await addDoc(laporanCollection, {
                    judul: judulInput.value,
                    nama: namaPelapor,
                    laporan: laporanInput.value,
                    status: "Terkirim",
                    tanggapan: "",
                    reward: false,
                    likes: 0,
                    createdAt: serverTimestamp()
                });
                complaintForm.reset();
                namaInput.disabled = false;
                namaInput.classList.remove('bg-gray-200');
                showToast("Laporan berhasil dikirim!");
                formLaporan.classList.add('hidden');
            } catch (error) {
                console.error("Error menambah laporan: ", error);
                showToast("Gagal mengirim laporan. Coba lagi.");
            } finally {
                // Re-enable button after submission attempt
                submitButton.disabled = false;
                submitButton.textContent = 'Kirim Laporan';
            }
        });
        
        async function handleAdminUpdate(docId, dataToUpdate) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/pengaduan`, docId);
                await updateDoc(docRef, dataToUpdate);
                showToast("Laporan berhasil diperbarui.");
            } catch (error) {
                console.error("Error memperbarui laporan:", error);
                showToast("Gagal memperbarui laporan.");
            }
        }
        
        async function handleLikeClick(docId) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/pengaduan`, docId);
                await updateDoc(docRef, {
                    likes: increment(1)
                });
            } catch (error) {
                console.error("Error updating likes:", error);
                showToast("Gagal menyukai laporan.");
            }
        }

        let localLaporanCache = [];
        
        function renderAllLaporan() {
            laporanContainer.innerHTML = '';
            
            const filteredLaporan = localLaporanCache.filter(doc => {
                if (currentUserRole !== 'admin' || currentFilter === 'Semua') {
                    return true;
                }
                return doc.data().status === currentFilter;
            });

             if (filteredLaporan.length === 0) {
                 if (localLaporanCache.length === 0) {
                    laporanContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada laporan yang masuk.</p>';
                 } else {
                    laporanContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Tidak ada laporan dengan status "${currentFilter}".</p>`;
                 }
             } else {
                 filteredLaporan.forEach(doc => {
                     const laporanElement = createLaporanCard(doc);
                     laporanContainer.appendChild(laporanElement);
                 });
             }
        }

        function renderFilterButtons() {
            const statuses = ["Semua", "Terkirim", "Diproses", "Selesai", "Ditolak"];
            filterContainer.innerHTML = '';
            statuses.forEach(status => {
                const button = document.createElement('button');
                button.textContent = status;
                button.dataset.status = status;
                button.className = 'py-2 px-4 rounded-full text-sm font-semibold transition-all duration-200';
                if (status === currentFilter) {
                    button.classList.add('bg-[#001F3F]', 'text-white', 'shadow-md');
                } else {
                    button.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100', 'border');
                }
                filterContainer.appendChild(button);
            });
        }

        function createLaporanCard(doc) {
            const data = doc.data();
            const id = doc.id;
            
            const timestamp = data.createdAt ? data.createdAt.toDate() : new Date();
            const formattedDate = timestamp.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            const statusClass = {
                "Terkirim": "bg-blue-100 text-blue-800",
                "Diproses": "bg-yellow-100 text-yellow-800",
                "Selesai": "bg-green-100 text-green-800",
                "Ditolak": "bg-red-100 text-red-800"
            };
            const statusColor = statusClass[data.status] || "bg-gray-100 text-gray-800";
            const rewardHTML = data.reward ? `<div class="mt-3 flex items-center gap-2 text-yellow-500 bg-yellow-50 font-semibold p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.006z" clip-rule="evenodd" /></svg>Laporan Membantu!</div>` : '';

            const card = document.createElement('div');
            card.className = `card p-5 card-status-${data.status}`;
            card.setAttribute('data-id', id);

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-xl text-[#001F3F]">${data.judul}</h3>
                        <p class="font-medium text-md text-gray-700">${data.nama}</p>
                    </div>
                    <span class="text-xs ${statusColor} font-semibold px-3 py-1 rounded-full">${data.status}</span>
                </div>
                <p class="text-gray-500 text-sm mb-3">${formattedDate}</p>
                <p class="text-gray-800 whitespace-pre-wrap">${data.laporan}</p>

                <div class="flex justify-between items-center mt-4">
                     <div class="flex items-center text-gray-500">
                        <button data-role="like" class="flex items-center space-x-1.5 p-2 -ml-2 rounded-lg hover:bg-red-50 hover:text-red-500 transition-colors duration-200">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                           <span class="pointer-events-none">Suka</span>
                        </button>
                        <span class="ml-1 font-semibold text-gray-700">${data.likes || 0}</span>
                    </div>
                    ${rewardHTML}
                </div>
                
                <div class="mt-4 border-t pt-4">
                    <h4 class="font-semibold text-gray-700">Tanggapan Sekolah:</h4>
                    ${data.tanggapan ? `<p class="text-gray-600 mt-1 whitespace-pre-wrap">${data.tanggapan}</p>` : `<p class="text-gray-400 mt-1 italic">Belum ada tanggapan.</p>`}
                </div>
                
                ${currentUserRole === 'admin' ? `
                <div class="admin-controls bg-gray-50 mt-4 border-t p-4 -m-5 mb-0 rounded-b-lg">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beri Tanggapan</label>
                            <textarea data-role="tanggapan" class="w-full px-3 py-2 rounded-lg form-input" rows="3">${data.tanggapan || ''}</textarea>
                        </div>
                        <div class="flex items-end gap-4">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ubah Status</label>
                                <select data-role="status" class="w-full px-3 py-2 form-input rounded-lg">
                                    <option value="Terkirim" ${data.status === 'Terkirim' ? 'selected' : ''}>Terkirim</option>
                                    <option value="Diproses" ${data.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                                    <option value="Selesai" ${data.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                    <option value="Ditolak" ${data.status === 'Ditolak' ? 'selected' : ''}>Ditolak</option>
                                </select>
                            </div>
                            <button data-role="reward" class="whitespace-nowrap font-semibold py-2 px-3 rounded-lg btn-yellow ${data.reward ? 'opacity-50 cursor-not-allowed' : ''}" ${data.reward ? 'disabled' : ''}>
                                Beri Reward
                            </button>
                        </div>
                        <button data-role="save" class="w-full mt-2 font-semibold py-2 px-4 rounded-lg btn-primary">
                            Simpan Perubahan
                        </button>
                    </div>
                </div>
                ` : ''}
            `;
            return card;
        }

        // --- Event Listeners ---
        loginSiswaBtn.addEventListener('click', () => { currentUserRole = 'siswa'; updateView(); });
        
        showAdminLoginBtn.addEventListener('click', () => {
            mainLoginButtons.classList.add('hidden');
            adminLoginForm.classList.remove('hidden');
        });

        cancelAdminLoginBtn.addEventListener('click', () => {
            mainLoginButtons.classList.remove('hidden');
            adminLoginForm.classList.add('hidden');
            adminPasswordInput.value = '';
        });

        adminPasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredPassword = adminPasswordInput.value;
            // PENTING: Password ini hanya untuk demonstrasi.
            // Dalam aplikasi nyata, jangan pernah menyimpan password di kode seperti ini.
            const ADMIN_PASSWORD = 'admin123';

            if (enteredPassword === ADMIN_PASSWORD) {
                currentUserRole = 'admin';
                updateView();
                // Reset tampilan login untuk sesi berikutnya
                mainLoginButtons.classList.remove('hidden');
                adminLoginForm.classList.add('hidden');
                adminPasswordInput.value = '';
            } else {
                showToast('Password salah!');
                adminPasswordInput.value = '';
            }
        });

        logoutBtn.addEventListener('click', () => { 
            currentUserRole = null; 
            currentFilter = 'Semua';
            updateView(); 
        });

        showFormButton.addEventListener('click', () => {
            formLaporan.classList.remove('hidden');
            formLaporan.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        cancelFormButton.addEventListener('click', () => {
            formLaporan.classList.add('hidden');
        });

        laporanContainer.addEventListener('click', (e) => {
            const target = e.target;
            const card = target.closest('[data-id]');
            if (!card) return;

            const docId = card.getAttribute('data-id');
            const roleTarget = target.closest('[data-role]');
            if (!roleTarget) return;

            const role = roleTarget.getAttribute('data-role');

            if (role === 'like') {
                handleLikeClick(docId);
            }

            if (currentUserRole !== 'admin') return;
            
            if (role === 'save') {
                const tanggapan = card.querySelector('[data-role="tanggapan"]').value;
                const status = card.querySelector('[data-role="status"]').value;
                handleAdminUpdate(docId, { tanggapan, status });
            } else if (role === 'reward') {
                handleAdminUpdate(docId, { reward: true });
            }
        });

        filterContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentFilter = e.target.dataset.status;
                renderFilterButtons();
                renderAllLaporan();
            }
        });

        function listenToLaporan() {
            const q = query(laporanCollection);
            onSnapshot(q, (snapshot) => {
                let docs = snapshot.docs;
                // Sort by timestamp, newest first
                docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                localLaporanCache = docs;
                renderAllLaporan();
            }, (error) => {
                console.error("Error saat mengambil data:", error);
                laporanContainer.innerHTML = '<p class="text-center text-red-500 py-4">Gagal memuat data laporan.</p>';
            });
        }
        
        authenticateAndInit();

    </script>
</body>
</html>

